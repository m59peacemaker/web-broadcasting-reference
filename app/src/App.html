<link href="https://fonts.googleapis.com/css?family=Roboto:400,700" rel="stylesheet">
<div class="broadcast">
  <AudioInputControls
    inputs="{{ devices.audioinput }}"
    :deviceSettings
    activeInputs="{{ activeDevices.audioinput}}"
    canActivateMoreInputs="{{ activeDevices.audioinput.length < Object.keys(devices.audioinput).length }}"
    master="{{ audioinputMaster }}"
    on:addAudioInputRequest="addAudioInput()"
    on:toggleMuteRequest="toggleMute(event.input.deviceId)"
  />
  <!--
  <div class="overlays">
    <Overlay>
      <VideoInputSelector bind:selected="selectedVideoInput">
        {{ (selectedVideoInput || {}).deviceId || 'No video inputs available' }}
      </VideoInputSelector>
  </div>
  -->
  <StreamingMedia
    ref:localMedia
    :videoTrack
    mirror="{{ frontFacing }}"
    :audioTrack
    muted="{{ !monitorMic }}"
  />
  <Modal center="false" initiallyHidden="true">
    <AudioInputSettings inputs="{{ devices.audioinput }}" />
  </Modal>
</div>

<script>
import 'webrtc-adapter'
import AudioInputControls from './AudioInputControls.html'
import AudioInputSettings from './AudioInputSettings.html'
import Overlay from './Overlay.html'
import AudioInputSelector from './AudioInputSelector.html'
import VideoInputSelector from './VideoInputSelector.html'
import StreamingMedia from './Video.html'
import Modal from 'svelte-modal'
import RecordingIndicator from './RecordingIndicator.html'
import RafLoop from './lib/raf-loop'
import { getDeep, setDeep, observeDeep, push } from 'svelte-extras'
import omitDeep from './lib/omit-deep'
import { normalize } from 'normalizr'
import devices$ from './stores/media-devices'
import activeDevices$ from './stores/active-media-devices'
import flyd from 'flyd'
import './state'

/*{
  videoinput: [],
  audioinput: []
  audioinput: [
    { volume: 0, muted: false, monitoring: false, error: true },
    { volume: 0.9, muted: false, monitoring: false },
    { volume: 0.4, muted: false, monitoring: true },
    { volume: 0, muted: true, monitoring: false }
  ]*/

// TODO: muteAll button, part of master audio controls to the right of audio inputs (where the + is)

const setDeepObject = function (keypath, object) {
  return setDeep.call(this, keypath, Object.assign(this.getDeep(keypath), object))
}
const getUserMedia = options => window.navigator.mediaDevices.getUserMedia(options)

const audioContext = new AudioContext()

const InitialDeviceState = {
  audio: (deviceId) => ({
    deviceId,
    volume: 0,
    monitoring: true
  })
}

export default {
  components: {
    AudioInputControls,
    AudioInputSettings,
    Overlay,
    AddAudioInput,
    AudioInputSmall,
    AudioInputSelector,
    VideoInputSelector,
    RecordingIndicator,
    Modal,
    StreamingMedia
  },

  data () {
    return {
      devices: devices$(),
      activeDevices: activeDevices$(),
      audioinputMaster: { muted: false, volume: 0.9 }
    }
  },

  oncreate () {
    flyd.on(v => this.set({ activeDevices: v }), activeDevices$)
    flyd.on(v => this.set({ devices: v }), devices$)
  },

  methods: {
    addAudioInput () {
      activeDevices$.request({ action: 'activate', payload: { kind: 'audioinput' } })
    }
/*    push,
    getDeep,
    setDeep,
    setDeepObject,
    observeDeep,
    toggleMute (deviceId) {
      const { track } = this.getDeep('activeDevices.inputs.audio')
        .find(input => input.deviceId === deviceId)
      track.enabled = !track.enabled
      this.setDeep(`deviceSettings.${deviceId}.muted`, !track.enabled)
    },
    getFirstInactiveInput (type) {
      const devices = this.getDeep(`devices.inputs.${type}`)
      const activeInputs = this.getDeep('activeDevices.inputs.audio')

      const activeDeviceIds = activeInputs.map(input => input.deviceId)
      return devices.find(device => !activeDeviceIds.includes(device.deviceId))
    },
    addAudioInput () {
      const device = this.getFirstInactiveInput('audio')

      if (!device) {
        throw new Error('there are no unused audio input devices available')
      }

      const index = this.getDeep('activeDevices.inputs.audio').length
      const keypath = `activeDevices.inputs.audio[${index}]`
      this.push('activeDevices.inputs.audio', InitialDeviceState.audio(device.deviceId))

      const updateAudioSource = async () => {
        const state = this.getDeep(keypath)

        if (state.sourceTrack) {
          state.sourceTrack.stop()
          state.rafLoop.cancel()
        }

        const settings = this.getDeep(`deviceSettings.${state.deviceId}`)
        const audioConstraints = getAudioInputConstraints(state.deviceId, settings)

        const stream = await getUserMedia({ audio: audioConstraints })
        const sourceTrack = stream.getAudioTracks()[0]

        const gainTrack = GainTrack(audioContext, sourceTrack)
        const volumeAnalyser = TrackVolumeAnalyser(audioContext, gainTrack.track)
        const updateVolume = () => this.setDeep(`${keypath}.volume`, volumeAnalyser.getVolume())
        const rafLoop = RafLoop(updateVolume)
        const track = gainTrack.track

        if (settings.muted) {
          track.enabled = false
        }

        this.setDeepObject(keypath, { track, sourceTrack, rafLoop })
      }

      this.observeDeep(`${keypath}.deviceId`, updateAudioSource)
    }*/
  }
}
</script>

<style>
.broadcast {
  position: fixed;
  top: 0;
  left: 0;
  bottom: 0;
  right: 0;
  background: rgb(10, 10, 10);
  color: white;
  font-family: 'Roboto', sans-serif;
}

/* may need to be a PR to svelte-modal */
.broadcast :global(.svelte-modal:focus) {
  outline: none;
}

.broadcast :global(video) {
  position: absolute;
  top: 0;
  left: 0;
  height: 100%;
  width: 100%;
  object-fit: cover;
  z-index: -1;
}

.broadcast :global(select) {
  padding: 8px;
  font-size: 16px;
  max-width: 100%;
}

.broadcast :global(button) {
  color: white;
  background: none;
  border: none;
  padding: 0;
  display: block;
  opacity: 0.7;
  font-size: 16px;
}

.broadcast :global(button:focus) {
  outline: none;
}

.broadcast :global(button:hover) {
  opacity: 1;
}

.broadcast :global(button:hover, a:hover) {
  cursor: pointer;
}

.broadcast :global(.volume-meter) {
  background: rgba(0, 0, 0, 0.7);
}

.broadcast :global(.audio-input-controls) {
  margin: 10px;
  display: inline-block;
  position: relative;
}

.broadcast :global(.audio-input-controls > *) {
  background: rgba(85, 85, 85, .5);
  display: inline-block;
}

.broadcast :global(.audio-input-master) {
  display: inline-block;
}

.broadcast :global(.audio-input-master, .add-audio-input) {
  margin-left: -4px;
  border: 4px solid rgba(85, 85, 85, 1);
}

.broadcast :global(.add-audio-input) {
  position: absolute;
  left: 100%;
  top: 4px;
}

.broadcast :global(.audio-input-small) {
  padding: 5px;
}

</style>
